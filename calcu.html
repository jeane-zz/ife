<!DOCTYPE html>
<html>
<head>
	<title>计算器</title>
</head>
<body>
<p>支持 sin\cos 括号内为一个规范a+b形式的计算式</p>
	<input type="text" name="" id="dataInput">
	<button id="submit">确认</button>

	<script type="text/javascript">


		var submitBtn = document.querySelector('#submit')
		var inputArea = document.querySelector('#dataInput')
		
		submitBtn.addEventListener('click', function(err){
			var inputStr = inputArea.value.replace(/\./g,'_').replace('（','(').replace('）',')').replace(/(\W)/g, ' $& ').replace(/_/g,'.')
			var arr = inputStr.split(' ').filter(it => it != '')

			// 处理括号问题。如果是算式直接运算，如果是数学函数，直接替换成数字
  			while(arr.indexOf('(') > -1){
  				var flag1 = arr.lastIndexOf('(')
  				var flag2 = arr.indexOf(')', flag1)
  				if(flag2 - flag1 == 4){
  					arr[flag1] = cal(flag1 + 1, flag1 + 2, flag1 + 3)
  					arr.splice(flag1 + 1, 4)
  				}
  				else if(flag2 - flag1 == 2){
  					arr[flag1] = arr[flag1 + 1]
  					arr.splice(flag1 + 1, 2)
  				}
  			}
			
  			var funArr = ['sin', 'cos']
  			funArr.forEach(it => {
  				while(arr.indexOf(it) > -1){
  					var flag3 = arr.indexOf(it)
  					arr[flag3] = calFun(flag3, it)
  					arr.splice(flag3 + 1, 1)
  				}
  			})

			exp(0)
			function exp(i){
				if(i >= arr.length - 1){
					console.log(arr[i])
					return arr[i]
				}
				if(parse(i + 1, i + 3)){
					arr[i+2] = cal(i,i+1,i+2)
					return exp(i+2)
				}else {
					arr[i+2] = cal(i+2,i+3,i+4)
					arr.splice(i+3,2)
					return exp(i)
				}
			}
			function cal(a,symbol,b){
				switch(arr[symbol]){
					case '+':return Number(arr[a]) + Number(arr[b])
					case "-":return arr[a] - arr[b]
					case '*':return arr[a] * arr[b]
					case "/":if(arr[b] !== 0){return arr[a] / arr[b]}else{throw new Error('除数不能为0')}
					case "%": return arr[a] % arr[b]
					case "^": return Math.pow(arr[a],arr[b])
				}
			}
			function parse(i, j){
				if(property(arr[i]) < property(arr[j])){
					return false
				}
				return true
			}// 优先级
			function property(a){
				switch(a){
					case '+': 
					case "-": return 1
					case '*': 
					case "/":
					case '%': 
					case "^": return 2
					default: return 0
				}
			}

			function calFun(index, value) {
				switch(value){
					case 'sin':return Math.sin(Number(arr[index + 1]))
				}
			}
		})

	</script>
</body>
</html>