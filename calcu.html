<!DOCTYPE html>
<html>
<head>
	<title>计算器</title>
	<style type="text/css">	
	section {
		height: 350px;
		box-shadow: 0px 0px 5px 10px #f2f2f2;
	}
	button {
		width: 46px;
		height: 30px;
		margin: 5px;
		font-size: 15px;
		font-weight: bold;
	}
	
	header {
		height: 100px;
		width: 100%;
		aborder: 1px solid #f2f2f2;
		padding: 10px;
		box-sizing: border-box;
		margin-top: -10px;
	}
	#dataInput,#dataOutput {
		display: inline-block;
		width: 70%;
		height: 24px;
	}
	#dataOutput {
		text-align: center;
		margin: 8px 0 4px 0;
		width: 100%;
	}

	#calc, #tip, #head {
		width: 320px;
		padding: 20px;
		margin: 0 auto;
	}
	#head {
		text-align: center;
	}
	</style>
</head>
<body>
<div id="head">
	<h2>算式计算器</h2>
</div>
<section id="calc">
	<header>
		<input type="text" name="" id="dataInput">
		<button id="submit">确认</button>
		<div id="dataOutput"></div>
	</header>
	<div>
		<button title="数字0" class="btn">0</button>
		<button title="数字1" class="btn">1</button>
		<button title="数字2" class="btn">2</button>
		<button title="数字3" class="btn">3</button>
		<button title="数字4" class="btn">4</button>
		<button title="数字5" class="btn">5</button>
		<button title="数字6" class="btn">6</button>
		<button title="数字7" class="btn">7</button>
		<button title="数字8" class="btn">8</button>
		<button title="数字9" class="btn">9</button>
		<button title="小数点" class="btn">.</button>
		<button title="加法运算" class="btn">+</button>
		<button title="减法运算" class="btn">-</button>
		<button title="乘法运算" class="btn">*</button>
		<button title="除法运算" class="btn">/</button>
		<button title="取模运算" class="btn">%</button>
		<button title="乘方运算" class="btn">^</button>
		<button title="" class="btn">(</button>
		<button title="" class="btn">)</button>
		<button title="返回该度数的sin值" class="btn">sin</button>
		<button title="返回该度数的cos值" class="btn">cos</button>
		<button title="返回该度数的tan值" class="btn">tan</button>
		<button title="返回该度数的cot值" class="btn">cot</button>
		<button title="返回该数的自然对数" class="btn">ln</button>
		<button title="返回该数的以10为底的对数" class="btn">log</button>
		<button title="返回该数的绝对值" class="btn">abs</button>
		<button title="返回该数的平方根" class="btn">sqrt</button>
		<button title="撤销上一步输入" id="del">←</button>
		<button title="清空输入框" id="clear">清零</button>
	</div>

</section>
<div id="tip">
	<h3>使用说明：请输入标准运算式</h3>
	<ul>
		<li>键盘或按钮点击输入，确认键进行运算</li>
		<li>支持加、减、乘、除、取模、乘方运算</li>
		<li>支持常用三角函数计算</li>
		<li>支持对数运算、绝对值、平方根运算</li>
		<li>支持小数、括号、嵌套运算</li>
		<li>三角函数仅支持角度值计算</li>

	</ul>
</div>		
	<script type="text/javascript">
		var submitBtn = document.querySelector('#submit')
		var inputArea = document.querySelector('#dataInput')
		var outputArea = document.querySelector('#dataOutput')

		var btnGroup = Array.from(document.querySelectorAll('.btn'))
		var deleteBtn = document.querySelector('#del')
		var clearBtn = document.querySelector('#clear')
		btnGroup.forEach(it =>{
			it.addEventListener('click',function (event) {
				// 连续多次点击不同的运算按钮，取最后一个
				if(judge(it.innerHTML) == 2){
					// 如果同是运算符，则撤销前一次输入
					if(judge(inputArea.value[inputArea.value.length - 1]) == 2) {
						inputArea.value = inputArea.value.slice(0, inputArea.value.length - 1)
						inputArea.value += it.innerHTML
						submitBtn.disabled = false
					}else if(judge(inputArea.value[inputArea.value.length - 1]) == 1) {
						alert('你的输入有问题')
						submitBtn.disabled = true
					}else{
						inputArea.value += it.innerHTML
						submitBtn.disabled = false
					}

				}
				else if(judge(it.innerHTML) == 1){
					// 如果同是运算符，则撤销前一次输入
					if(judge(inputArea.value[inputArea.value.length - 1]) == 1 || judge(inputArea.value[inputArea.value.length - 1]) == 3) {
						alert('你的输入有问题')
						submitBtn.disabled = true
					}else{
						inputArea.value += it.innerHTML
						submitBtn.disabled = false
					}
				// 连续输入小数点	
				}else if(judge(it.innerHTML) == 3){
					// 如果同是运算符，则撤销前一次输入
					if(judge(inputArea.value[inputArea.value.length - 1]) == 3) {
						submitBtn.disabled = false
					}
					else if(judge(inputArea.value[inputArea.value.length - 1]) == 2) {
						inputArea.value += it.innerHTML
						submitBtn.disabled = false
					}if(judge(inputArea.value[inputArea.value.length - 1]) != 0) {
						alert('你的输入有问题')
						submitBtn.disabled = true
					}
				}else{
					inputArea.value += it.innerHTML
					submitBtn.disabled = false
				}
			})
		})




		deleteBtn.addEventListener('click',function () {
			inputArea.value = inputArea.value.slice(0, inputArea.value.length - 1)
		})
		clearBtn.addEventListener('click',function () {
			inputArea.value = ''
		})

		submitBtn.addEventListener('click', function(){
			var res = parseExp(inputArea.value)
			outputArea.innerHTML = res
		})

		function parseExp(str) {
			var inputStr = str.replace(/\./g,'_').replace('（','(').replace('）',')').replace(/(\W)/g, ' $& ').replace(/_/g,'.')
			var arr = inputStr.split(' ').filter(it => it != '')

			// 如果以负数开头 ，以0开头
  			if(arr[0] == '-'){
  				arr.unshift(0)
  			}

			// 处理括号问题。
  			while(arr.indexOf('(') > -1){
  				var flag1 = arr.lastIndexOf('(')
  				var flag2 = arr.indexOf(')', flag1)
  				tempStr = arr.slice(flag1 + 1, flag2).join('')
  					arr[flag1] = parseExp(tempStr)
  					arr.splice(flag1 + 1, flag2 - flag1)
  			}
			// 处理函数问题
  			var funArr = ['sin', 'cos','tan', 'cot','abs','sqrt','log','ln']
  			funArr.forEach(it => {
  				while(arr.indexOf(it) > -1){
  					var flag3 = arr.indexOf(it)
  					arr[flag3] = calFun(flag3, it)
  					arr.splice(flag3 + 1, 1)
  				}
  			})		
  			
			// 结束条件
			if(arr.length == 1) {
				return arr[0]
			}

  			// 如果是最简单的 a + b
  			if(arr.length == 3){
  				arr[0] = cal(0, 1, 2)
  				arr.splice(1,2)
  				return arr[0]
  			}
  			// 如果是连续的 a + b *c 
  			if(arr.length >= 5 && arr.length % 2 == 1){
  				while(arr.length > 1){
  					var flag = parse(1, 3)
  					if(flag){
  						arr[0] = cal(0, 1, 2)
  						arr.splice(1,2)
  					}else {
  						arr[2] = cal(2, 3, 4)
  						arr.splice(3,2)
  					}

  				}
  				return arr[0]		
  			}
  			// 基本的双目运算
  			function cal(a,symbol,b){
				switch(arr[symbol]){
					case '+':return Number(arr[a]) + Number(arr[b])
					case "-":return arr[a] - arr[b]
					case '*':return arr[a] * arr[b]
					case "/":if(arr[b] !== 0){return arr[a] / arr[b]}else{throw new Error('除数不能为0')}
					case "%": return arr[a] % arr[b]
					case "^": return Math.pow(arr[a],arr[b])
				}
			}

			// Math系列函数
			function calFun(index, value) {
				switch(value){
					case 'sin':return Math.sin(Number(arr[index + 1]* Math.PI/180))
					case 'cos':return Math.cos(Number(arr[index + 1]* Math.PI/180))
					case 'tan':return Math.tan(Number(arr[index + 1]* Math.PI/180))
					case 'cot':return Math.cos(Number(arr[index + 1]* Math.PI/180))/Math.sin(Number(arr[index + 1]* Math.PI/180))
					case 'sqrt':return Math.sqrt(Number(arr[index + 1]))
					case 'abs':return Math.abs(Number(arr[index + 1]))	
					case 'log':return Math.log10(Number(arr[index + 1]))
					case 'ln':return Math.log(Number(arr[index + 1]))
					
				}
			}
			// 优先级比较
			function parse(i, j){
				if(property(arr[i]) < property(arr[j])){
					return false
				}
				return true
			}

			// 优先级设置
			function property(a){
				switch(a){
					case '+': 
					case "-": return 1
					case '*': 
					case "/":
					case '%': 
					case "^": return 2
					default: return 0
				}
			}

		}

		// 判断相连的输入是否冲突
		function judge(value) {
			switch(value) {
				case '.': return 3
				case '+': 
				case "-": 
				case '*': 
				case "/":
				case '%': 
				case "^": return 2
				case 'sin': 
				case 'cos': 
				case 'tan': 
				case 'cot':
				case 'sqrt': 
				case 'abs':
				case 'log': 
				case 'ln': 
				case 's': 
				case 'i': 
				case 'n':
				case 'c':
				case 'o': 
				case 't': 
				case 'a':
				case 'q':
				case 'r': 
				case 'b': 
				case 'l':
				case 'g': return 1
				default: return 0
			}
		}


	</script>
</body>
</html>